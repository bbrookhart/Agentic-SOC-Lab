let Lookback = 1h;
let ExternalTools = dynamic(["web_request","email_send","webhook_post"]);
let SensitivePatterns = dynamic([
  @"AKIA[0-9A-Z]{16}",
  @"-----BEGIN PRIVATE KEY-----",
  @"\b\d{3}-\d{2}-\d{4}\b",
  @"xox[baprs]-"
]);
let DenyRulePrefixes = dynamic(["rule:tenant_boundary","rule:retrieval_"]);

let Denies =
  AgenticSocLab_CL
  | where EventType == "POLICY_DECISION"
  | where todatetime(EventTime) >= ago(Lookback)
  | extend Decision=tostring(RawEvent.policy.decision),
           Rule=tostring(RawEvent.policy.rule_id)
  | where Decision == "deny"
  | where Rule has_any (DenyRulePrefixes)
  | project DenyTime=todatetime(EventTime), SessionId, TraceId, Tenant, ActorId, DeniedRule=Rule;

let Outbound =
  AgenticSocLab_CL
  | where EventType == "TOOL_CALL"
  | where todatetime(EventTime) >= ago(Lookback)
  | extend Tool=tostring(RawEvent.tool_call.tool),
           Target=tostring(RawEvent.tool_call.target),
           ToolBlob=tostring(RawEvent.tool_call),
           Args=tostring(RawEvent.tool_call.args)
  | where Tool in (ExternalTools)
  | where ToolBlob has_any (SensitivePatterns) or Args has_any (SensitivePatterns)
  | project OutTime=todatetime(EventTime), SessionId, TraceId, Tenant, ActorId, Tool, Target, Args;

Denies
| join kind=innerunique Outbound on SessionId, TraceId
| where OutTime between (DenyTime .. DenyTime + 30m)
| project TimeGenerated=OutTime, Severity="High", RuleId="D004",
          SessionId, TraceId, Tenant, ActorId, DeniedRule, DenyTime, Tool, Target, OutTime, Args
